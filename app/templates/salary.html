{% extends "base.html" %}
{% block styles %}
<style>
  .net-card {
    background: linear-gradient(180deg, rgba(13,110,253,.08), rgba(255,255,255,0));
  }
    /* Table row highlights */
  tr.row-weekend td { background-color: rgba(13,110,253,.07) !important; }   /* blue-ish */
  tr.row-holiday td { background-color: rgba(255,193,7,.15) !important; }    /* yellow-ish */
  tr.row-leave td   { background-color: rgba(220,53,69,.10) !important; }    /* red-ish */

  /* make badges nicer */
  .badge-soft {
    font-weight: 600;
    border: 1px solid rgba(0,0,0,.08);
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">Salary Tracker</h4>
    <div class="text-muted small">Month view (coming next)</div>
  </div>

  <form class="d-flex gap-2" method="get">
    <select class="form-select form-select-sm" name="month" style="width: 110px;">
      {% for m in range(1, 13) %}
        <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
      {% endfor %}
    </select>

    <select class="form-select form-select-sm" name="year" style="width: 120px;">
      {% for y in range(year-2, year+5) %}
        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>

    <button class="btn btn-sm btn-primary">Go</button>
    <a class="btn btn-sm btn-outline-dark"
   href="{{ url_for('main.salary_payslip_pdf', year=year, month=month) }}">
  <i class="bi bi-download me-1"></i> Download Payslip (PDF)
</a>

  </form>
</div>

<div class="row g-3 align-items-stretch mt-1">
  <!-- LEFT: 3 cards top + 3 cards bottom -->
  <div class="col-lg-9">
    <div class="row g-3">

      <!-- 1) Base Salary -->
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="text-muted small">Base Salary</div>
            <div class="fs-4 fw-semibold text-primary">
              {{ base_salary_str }}
            </div>
            <div class="small text-muted">
              Fixed monthly
            </div>
          </div>
        </div>
      </div>

      <!-- 2) Overtime (weekday OT) -->
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="text-muted small">Overtime</div>
            <div class="fs-4 fw-semibold text-success">
              {{ overtime_pay_str }}
            </div>
            <div class="small text-muted">
              Hours: <span class="fw-semibold">{{ overtime_hours_str }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 3) Weekend/Holiday -->
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="text-muted small">Weekend / Holiday Work</div>
            <div class="fs-4 fw-semibold text-success">
              {{ weekend_holiday_pay_str }}
            </div>
            <div class="small text-muted">
              Days: <span class="fw-semibold">{{ weekend_holiday_days }}</span>
              · Hours: <span class="fw-semibold">{{ weekend_holiday_hours_str }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 4) Allowance -->
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="text-muted small">Allowance</div>
            <div class="fs-4 fw-semibold text-success">
              {{ allowance_str }}
            </div>
            <div class="small text-muted">
              Optional additions
            </div>
          </div>
        </div>
      </div>

      <!-- 5) Deductions -->
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="text-muted small">Deductions (Insurance / Tax)</div>
            <div class="fs-4 fw-semibold text-danger">
              {{ deductions_str }}
            </div>
            <div class="small text-muted">
              Insurance + tax + others
            </div>
          </div>
        </div>
      </div>

      <!-- 6) Leave + Penalty (grouped) -->
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="text-muted small">Leave Deduction + Penalty</div>
            <div class="fs-4 fw-semibold text-danger">
              {{ leave_total_deduction_str }}
            </div>
            <div class="small text-muted">
              Leave days: <span class="fw-semibold">{{ leave_days }}</span>
              · Penalty days: <span class="fw-semibold">{{ penalty_days }}</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- RIGHT: Net Salary (spans 2 rows visually) -->
  <div class="col-lg-3">
    <div class="card shadow-sm border-0 h-100 net-card">
      <div class="card-body d-flex flex-column justify-content-between">
        <div>
          <div class="text-muted small">Net Salary (Estimated)</div>

          {# If you later pass net_salary_value as a number, we’ll auto color it.
             For now it’s just placeholder. #}
          <div class="display-6 fw-bold net-amount text-primary">
            {{ net_salary_str }}
          </div>
          <div class="text-muted small mt-3">
            Gross salary:
            <span class="fw-bold text-primary">{{ gross_salary_str }}</span>
          </div>
        </div>

        <div class="mt-3 pt-3 border-top">
          <div class="d-flex justify-content-between small">
            <span class="text-muted">Gross add-ons</span>
            <span class="text-success fw-semibold">{{ gross_additions_str }}</span>
          </div>
          <div class="d-flex justify-content-between small">
            <span class="text-muted">Total deductions</span>
            <span class="text-danger fw-semibold">{{ total_deductions_str }}</span>
          </div>
          <div class="d-flex justify-content-between small">
            <span class="text-muted">Short deduction:(<span class="text-danger">{{ (short_minutes/60) | round(2) }}h</span>)</span>
            <span class="text-danger fw-semibold">{{ "{:,}".format(short_hours_deduction|int) }}₩</span>
             
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="accordion mt-3" id="salaryAdjustAccordion">
  <div class="accordion-item shadow-sm">
    <h2 class="accordion-header">
      <button
        class="accordion-button collapsed"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#salaryAdjustCollapse"
        aria-expanded="false"
        aria-controls="salaryAdjustCollapse"
      >
        <div class="d-flex w-100 justify-content-between align-items-center">
          <span class="fw-semibold">Allowances &amp; Deductions</span>
          <span class="text-muted small ms-2">Monthly lines (보험/세금/수당)</span>
        </div>
      </button>
    </h2>

    <div
      id="salaryAdjustCollapse"
      class="accordion-collapse collapse"
      data-bs-parent="#salaryAdjustAccordion"
    >
      <div class="accordion-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
  <div class="text-muted small">
    Tip: copy last month, then edit only what changed.
  </div>

  <form method="post" action="{{ url_for('main.salary_adjust_copy_prev') }}">
    {% if csrf_token is defined %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% endif %}
    <input type="hidden" name="year" value="{{ year }}">
    <input type="hidden" name="month" value="{{ month }}">
    <button class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-copy me-1"></i> Copy from previous month
    </button>
  </form>
</div>

        <!-- Add line -->
        <form class="row g-2" method="post" action="{{ url_for('main.salary_adjust_add') }}">
          {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}

          <input type="hidden" name="year" value="{{ year }}">
          <input type="hidden" name="month" value="{{ month }}">

          <div class="col-md-3">
            <label class="form-label small">Type</label>
            <select class="form-select form-select-sm" name="kind" required>
              <option value="allowance">Allowance (+)</option>
              <option value="deduction">Deduction (−)</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label small">Label</label>
            <input class="form-control form-control-sm" name="label" placeholder="e.g., Health Insurance" required>
          </div>

          <div class="col-md-3">
            <label class="form-label small">Amount (KRW)</label>
            <input type="number" class="form-control form-control-sm" name="amount" min="0" required>
          </div>

          <div class="col-12 d-flex justify-content-end">
            <button class="btn btn-sm btn-primary">Add</button>
          </div>
        </form>

        <hr class="my-3">

        <!-- List lines -->
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr class="text-muted small">
                <th style="width:140px;">Type</th>
                <th>Label</th>
                <th class="text-end" style="width:160px;">Amount</th>
                <th class="text-end" style="width:110px;">Action</th>
              </tr>
            </thead>

            <tbody class="small">
              {% for a in adjustments %}
                <tr data-adj-id="{{ a.id }}">
                <td class="cell-kind">
                    {% if a.kind == "allowance" %}
                    <span class="badge text-bg-success">Allowance</span>
                    {% else %}
                    <span class="badge text-bg-danger">Deduction</span>
                    {% endif %}
                </td>

                <td class="cell-label text-muted">{{ a.label }}</td>

                <td class="cell-amount text-end fw-semibold {% if a.kind == 'allowance' %}text-success{% else %}text-danger{% endif %}">
                    {% if a.kind == "allowance" %}+{% else %}-{% endif %}
                    {{ "{:,}".format(a.amount|int) }}₩
                </td>

                <td class="text-end">
                <div class="d-inline-flex align-items-center gap-1">

                    <button type="button" class="btn btn-sm btn-outline-primary btn-edit">
                    Edit
                    </button>

                    <button type="button" class="btn btn-sm btn-outline-secondary btn-cancel d-none">
                    Cancel
                    </button>

                    <button type="button" class="btn btn-sm btn-primary btn-save d-none">
                    Save
                    </button>

                    <form method="post"
                        action="{{ url_for('main.salary_adjust_delete', adj_id=a.id) }}"
                        class="d-inline">
                    {% if csrf_token is defined %}
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% endif %}
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="month" value="{{ month }}">
                    <button class="btn btn-sm btn-outline-danger">
                        Delete
                    </button>
                    </form>

                </div>
                </td>


                <!-- hidden edit UI template (will be injected by JS) -->
                <template class="edit-template">
                    <td>
                    <select class="form-select form-select-sm inp-kind">
                        <option value="allowance" {% if a.kind=='allowance' %}selected{% endif %}>Allowance (+)</option>
                        <option value="deduction" {% if a.kind=='deduction' %}selected{% endif %}>Deduction (−)</option>
                    </select>
                    </td>
                    <td>
                    <input class="form-control form-control-sm inp-label" value="{{ a.label }}">
                    </td>
                    <td>
                    <input type="number" min="0" class="form-control form-control-sm inp-amount text-end" value="{{ a.amount|int }}">
                    </td>
                </template>
                </tr>

              {% else %}
                <tr>
                  <td colspan="4" class="text-muted text-center py-3">No allowances/deductions added for this month.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="accordion mt-3" id="salaryLeaveAccordion">
  <div class="accordion-item shadow-sm">
    <h2 class="accordion-header">
      <button
        class="accordion-button collapsed"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#salaryLeaveCollapse"
        aria-expanded="false"
        aria-controls="salaryLeaveCollapse"
      >
        <div class="d-flex w-100 justify-content-between align-items-center">
          <span class="fw-semibold">Long Leave</span>
          <span class="text-muted small ms-2">Apply leave for a date range (skips weekends + holidays)</span>
        </div>
      </button>
    </h2>

    <div
      id="salaryLeaveCollapse"
      class="accordion-collapse collapse"
      data-bs-parent="#salaryLeaveAccordion"
    >
      <div class="accordion-body">

        <form class="row g-2" method="post" action="{{ url_for('main.salary_long_leave_apply') }}">
          {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}

          <div class="col-md-3">
            <label class="form-label small">Start date</label>
            <input type="date" class="form-control form-control-sm" name="start_date"
                   value="{{ today.isoformat() }}" required>
          </div>

          <div class="col-md-3">
            <label class="form-label small">End date</label>
            <input type="date" class="form-control form-control-sm" name="end_date"
                   value="{{ today.isoformat() }}" required>
          </div>

          <div class="col-md-4">
            <label class="form-label small">Note (optional)</label>
            <input type="text" class="form-control form-control-sm" name="note"
                   placeholder="e.g., Vacation / Bangladesh trip">
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="overwrite" id="overwriteLeave">
              <label class="form-check-label small" for="overwriteLeave">
                Overwrite
              </label>
            </div>
          </div>

          <div class="col-12 d-flex justify-content-between align-items-center">
            <div class="small text-muted">
              Overwrite will replace existing entries in that range (use carefully).
            </div>
            <button class="btn btn-sm btn-danger">
              Apply Leave Range
            </button>
            
          </div>
        </form>
<hr class="my-3">
        <!-- Remove leave range -->

<form class="row g-2" method="post" action="{{ url_for('main.salary_long_leave_remove') }}">
  {% if csrf_token is defined %}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  {% endif %}

  <div class="col-md-3">
    <label class="form-label small">Start date</label>
    <input type="date" class="form-control form-control-sm" name="start_date"
           value="{{ today.isoformat() if today is defined else '' }}" required>
  </div>

  <div class="col-md-3">
    <label class="form-label small">End date</label>
    <input type="date" class="form-control form-control-sm" name="end_date"
           value="{{ today.isoformat() if today is defined else '' }}" required>
  </div>

  <div class="col-12 d-flex justify-content-between align-items-center">
    <div class="small text-muted">
      Only removes logs that were marked as full-day leave.
    </div>
    <button class="btn btn-sm btn-outline-danger">
      Remove Leave Range
    </button>
  </div>
</form>

      </div>
    </div>
  </div>
</div>

<div class="accordion mt-3" id="salaryEntryAccordion">
  <div class="accordion-item shadow-sm">
    <h2 class="accordion-header">
      <button
        class="accordion-button collapsed"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#salaryEntryCollapse"
        aria-expanded="false"
        aria-controls="salaryEntryCollapse"
      >
        <div class="d-flex w-100 justify-content-between align-items-center">
          <span class="fw-semibold">Daily Entry</span>
          <span class="text-muted small ms-2">
            IN / OUT · Lunch · Leave
          </span>
        </div>
      </button>
    </h2>

    <div
      id="salaryEntryCollapse"
      class="accordion-collapse collapse"
      data-bs-parent="#salaryEntryAccordion"
    >
      <div class="accordion-body">

        <form class="row g-2" method="post" action="{{ url_for('main.salary_log_save') }}">
          {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}

          <div class="col-md-3">
            <label class="form-label small">Date</label>
            <input
            type="date"
            class="form-control form-control-sm"
            name="work_date"
            value="{{ today.isoformat() }}"
            required
            >
          </div>

          <div class="col-md-2">
            <label class="form-label small">IN</label>
            <input
            type="text"
            class="form-control form-control-sm timepicker"
            name="in_time"
            placeholder="07:00"
            autocomplete="off"
            >
          </div>

          <div class="col-md-2">
            <label class="form-label small">OUT</label>
            <input
            type="text"
            class="form-control form-control-sm timepicker"
            name="out_time"
            placeholder="18:00"
            autocomplete="off"
            >
          </div>

          <div class="col-md-2">
            <label class="form-label small">Lunch (min)</label>
            <input
              type="number"
              class="form-control form-control-sm"
              name="lunch_minutes"
              value="{{ default_lunch_minutes }}"
              min="0"
            >
          </div>

          <div class="col-md-3 d-flex align-items-end">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                name="is_full_day_leave"
                id="fullLeave"
              >
              <label class="form-check-label small" for="fullLeave">
                Full-day leave
              </label>
            </div>
          </div>

          <div class="col-12">
            <input
              type="text"
              class="form-control form-control-sm"
              name="note"
              placeholder="Note (optional)"
            >
          </div>

          <div class="col-12 d-flex justify-content-end">
            <button class="btn btn-sm btn-success">
              Save Day
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mt-3">
  <div class="card-body">
    <h6 class="mb-2">This Month Logs</h6>

    <div class="table-responsive">
      <table class="table table-sm align-middle table-striped table-bordered">
        <thead class="table-dark">
          <tr class="text-muted small">
            <th>Date</th>
            <th>IN</th>
            <th>OUT</th>
            <th>Lunch</th>
            <th>Worked</th>
            <th>Regular</th>
            <th>OT</th>
            <th>Leave</th>
            <th>Note</th>
          </tr>
        </thead>
<tbody class="small">
  {% for d in days %}
    {% set l = log_by_date.get(d) %}
    {% set dstr = d.isoformat() %}
    {% set isWeekend = d.weekday() >= 5 %}
    {% set isHoliday = dstr in holiday_dates %}
    {% set isLeave = l and l.is_full_day_leave %}

    <tr class="
      {% if isLeave %}row-leave
      {% elif isHoliday %}row-holiday
      {% elif isWeekend %}row-weekend
      {% endif %}
    ">
      <!-- Date + badges -->
      <td>
        {{ d.strftime("%Y-%m-%d") }}
        <span class="text-muted">({{ d.strftime("%a") }})</span>

        {% if isHoliday %}
          <span class="badge badge-soft text-bg-warning ms-1">Holiday</span>
        {% elif isWeekend %}
          <span class="badge badge-soft text-bg-primary ms-1">Weekend</span>
        {% endif %}

        {% if isLeave %}
          <span class="badge badge-soft text-bg-danger ms-1">Leave</span>
        {% endif %}
      </td>

      <!-- IN -->
      <td>
        {{ l.in_time.strftime("%H:%M") if l and l.in_time else "—" }}
      </td>

      <!-- OUT -->
      <td>
        {{ l.out_time.strftime("%H:%M") if l and l.out_time else "—" }}
      </td>

      <!-- Lunch -->
      <td>
        {{ l.lunch_minutes if l else 0 }}
      </td>

      <!-- Worked -->
      <td>
        {{ (((l.worked_minutes or 0) if l else 0) / 60) | round(1) }}
      </td>

      <!-- Regular -->
      <td>
        {{ (((l.regular_minutes or 0) if l else 0) / 60) | round(1) }}
      </td>

      <!-- Overtime -->
      {% set otm = (l.overtime_minutes or 0) if l else 0 %}
      <td class="fw-semibold {% if otm > 0 %}text-success{% endif %}">
        {{ (otm / 60) | round(1) }}
      </td>

      <!-- Leave -->
      <td>
        {% if isLeave %}
          <span class="fw-semibold text-danger">Yes</span>
        {% else %}
          <span class="text-muted">No</span>
        {% endif %}
      </td>

      <!-- Note -->
      <td class="text-muted">
        {{ l.note if l and l.note else "" }}
      </td>
    </tr>

  {% endfor %}
</tbody>

      </table>
    </div>
  </div>
</div>
<div class="card shadow-sm mt-4">
  <div class="card-body">
    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
      <div>
        <div class="fw-semibold">Salary Summary</div>
        <div class="text-muted small">Gross vs Net (year trend + selected period)</div>
      </div>

      <div class="d-flex gap-2 align-items-end">
        <div>
          <label class="form-label small mb-1">Year</label>
          <select id="sumYear" class="form-select form-select-sm">
          {% for y in range(year-3, year+2) %}
            <option value="{{ y }}" {% if y==year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
          </select>
        </div>

        <div>
          <label class="form-label small mb-1">Month</label>
          <select id="sumMonth" class="form-select form-select-sm">
            <option value="">Whole Year</option>
            {% for m in range(1, 13) %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </div>

        <button id="sumApply" class="btn btn-sm btn-primary">
          Apply
        </button>
      </div>
    </div>

    <div class="row g-3 align-items-stretch">
      <!-- Left: chart (80% width inside column) -->
      <div class="col-lg-8">
        <div class="d-flex justify-content-center">
          <div style="width:80%;">
            <canvas id="salaryLineChart" height="170"></canvas>
          </div>
        </div>
      </div>

      <!-- Right: text summary -->
      <div class="col-lg-4">
        <div class="border rounded-3 p-3 h-100 bg-light">
          <div class="fw-semibold mb-2">Selected Summary</div>

          <div class="d-flex justify-content-between small mb-2">
            <span class="text-muted" id="sumLabel">—</span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Gross</span>
            <span class="fw-semibold" id="sumGross">—</span>
          </div>

          <div class="d-flex justify-content-between">
            <span class="text-muted">Net</span>
            <span class="fw-semibold" id="sumNet">—</span>
          </div>

          <hr class="my-3">

          <div class="small text-muted">
            Gross = Base + OT + Weekend/Holiday + Allowance
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

{% endblock %}
