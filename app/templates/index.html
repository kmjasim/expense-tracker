{# templates/index.html #}
{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-0 main-dashboard">
  <div class="row g-3">
    <!-- First Column (60%) -->
    <div class="col-12 col-lg-6 d-flex flex-column">
      <!-- First Grid (40% height) -->
      <div class="flex-fill mb-3" style="flex: 0 0 40%;">
        <div class="row g-3 h-100">
          <!-- Income Card -->
          <div class="col-12 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="d-flex align-items-start mb-2">
                      <div class="bg-light rounded-circle p-1 me-1">
                        <i class="bi bi-wallet2 text-success"></i>
                      </div>
                      <span class="fw-semibold fs-5">Income</span>
                    </div>
                    <h3 class="fw-bold fs-5 mb-0">{{ cards.income.value_fmt }}</h3>
                  </div>
                  <div class="text-end">
                    <span class="badge rounded-pill {{ cards.income.badge_class }} mb-1">
                      {{ cards.income.delta_pct_fmt }}
                    </span>
                    <div><small class="text-muted">{{ cards.income.delta_abs_fmt }} than last month</small></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Expenses Card -->
          <div class="col-12 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="d-flex align-items-start mb-2">
                      <div class="bg-light rounded-circle p-1 me-1">
                        <i class="bi bi-cart4 text-danger"></i>
                      </div>
                      <span class="fw-semibold fs-5">Expenses</span>
                    </div>
                    <h3 class="fw-bold fs-5 mb-0">{{ cards.expenses.value_fmt }}</h3>
                  </div>
                  <div class="text-end">
                    <span class="badge rounded-pill {{ cards.expenses.badge_class }} mb-1">
                      {{ cards.expenses.delta_pct_fmt }}
                    </span>
                    <div><small class="text-muted">{{ cards.expenses.delta_abs_fmt }} than last month</small></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Expenses Card -->
          <div class="col-12 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="d-flex align-items-start mb-2">
                      <div class="bg-light rounded-circle p-1 me-1">
                        <i class="bi bi-credit-card text-warning"></i>
                      </div>
                      <span class="fw-semibold fs-5">Pending</span>
                    </div>
                    <h3 class="fw-bold fs-5 mb-0">{{ cards.pending.value_fmt }}</h3>
                  </div>
                  <div class="text-end">
                    <span class="badge rounded-pill {{ cards.pending.badge_class }} mb-1">
                      {{ cards.pending.delta_pct_fmt }}
                    </span>
                    <div><small class="text-muted">{{ cards.pending.delta_abs_fmt }} than last month</small></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Savings Card -->
          <div class="col-12 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="d-flex align-items-start mb-2">
                      <div class="bg-light rounded-circle p-1 me-1">
                        <i class="bi bi-piggy-bank text-primary"></i>
                      </div>
                      <span class="fw-semibold fs-5">Savings</span>
                    </div>
                    <h3 class="fw-bold fs-5 mb-0">
                      {{ 0 if cards.savings.value <= 0 else cards.savings.value_fmt }}
                    </h3>
                  </div>
                  <div class="text-end">
                    <span class="badge rounded-pill {{ cards.savings.badge_class }} mb-1">
                      {{ cards.savings.delta_pct_fmt }}
                    </span>
                    <div><small class="text-muted">{{ cards.savings.delta_abs_fmt }} than last month</small></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Second Grid (60% height) -->
      <div class="flex-fill" style="flex: 0 0 60%;">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="fw-bold mb-0">Cashflow</h5>
              <select id="yearSelect" class="form-select form-select-sm w-auto">
                {# recent 10 years: current down to current-9 #}
                {% for y in range(year, year-5, -1) %}
                  <option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <span class="text-muted">Total Balance</span>
              <h3 class="fw-bold text-success" id="totalBalance"></h3>
            </div>
            <canvas id="cashflowChart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Second Column (20%) -->
    <div class="col-12 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="fw-bold mb-0">Expense Breakdown</h6>
            <div class="d-flex gap-2">
              <!-- Year select (last 10 years) -->
              <select id="breakdownYear" class="form-select form-select-sm w-auto">
                {% for y in range(year, year-10, -1) %}
                  <option value="{{ y }}" {{ 'selected' if y == year else '' }}>{{ y }}</option>
                {% endfor %}
              </select>

              <!-- Month select (01â€“12) -->
              <select id="breakdownMonth" class="form-select form-select-sm w-auto">
                {% for m in range(1, 13) %}
                  <option value="{{ "%02d"|format(m) }}" {{ 'selected' if m == month else '' }}>
                    {{ "%02d"|format(m) }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="mb-3">
            <canvas id="expenseBreakdownChart" height="220"></canvas>
          </div>

          <div class="mb-2">
            <span class="text-muted">Total Expense</span>
            <div class="d-flex align-items-center gap-2">
              <h3 class="fw-bold mb-0" id="expTotal"></h3>
              <span id="expChange" class="badge rounded-pill bg-success-subtle text-success"></span>
            </div>
          </div>

          <hr class="my-2">
          <div id="expList" class="flex-grow-1 overflow-auto" style="max-height: 300px;"></div>
        </div>
      </div>
    </div>

    <!-- Third Column (20%) -->
    <div class="col-12 col-lg-3 d-flex flex-column">
      <div class="flex-fill mb-0" style="flex: 0 0 30%;">
        <div id="financeScoreSection"
            class="card shadow-sm finance-score-card"
            data-api="{{ url_for('main.api_finance_score') }}">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <div class="fw-bold fs-3">Finance Score</div>
                <div class="text-muted small fs-6">Finance Quality</div>
              </div>
            </div>
              <div class="d-flex gap-1 py-3">
                <select id="fsYear" class="form-select form-select-sm" style="max-width:100px">
                  {% for y in range(2023, today.year + 1) %}
                    <option value="{{ y }}" {{ 'selected' if y == today.year else '' }}>{{ y }}</option>
                  {% endfor %}
                </select>
                <select id="fsMonth" class="form-select form-select-sm" style="max-width:90px">
                  {% for m in range(1, 13) %}
                    <option value="{{ m }}" {{ 'selected' if m == today.month else '' }}>{{ "%02d"|format(m) }}</option>
                  {% endfor %}
                </select>
              </div>
            <div class="d-flex justify-content-between align-items-end mb-3">
              <div class="display-6 fw-bold mb-0 fs-3" data-role="fs-label">{{ finance_score.label }}</div>
              <div class="fw-semibold fs-4" data-role="fs-score">{{ finance_score.score }}%</div>
            </div>

            <div class="d-flex align-items-center gap-1">
              <div id="financeScoreBar" class="rounded-pill bar-light" style="height:14px; width: {{ finance_score.score * 0.8 }}px;"></div>
              <div class="flex-grow-1 rounded-pill bg-dark-subtle bar-dark" style="height:14px;"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex-fill mt-3" style="flex: 0 0 70%;">
          <!-- Top: Total of the top 2 BDT accounts -->
        <div class="bankwidget">
          <div class="card shadow-sm bdt-widget mb-2 p-2 d-flex">
            <div class="card-body text-center py-1 flex-column gap-1">
              <div class="fs-4 fw-bold">Total Balance</div>
              <div class="h4 fw-bold mb-0">à§³{{ "{:,}".format((bdt_total_all or 0)|int) }}</div>
              <div class="text-muted tiny">
                Included:
                {% if bdt_accounts_with_bal %}
                  {{ bdt_accounts_with_bal | map(attribute='name') | join(', ') }}
                {% else %}â€”{% endif %}
              </div>
            </div>
          </div>

          <!-- Bottom: Stacked account cards (one per row) -->
          <div class="card shadow-sm">
            <div class="card-body pb-5 px-2 overflow-auto" style="max-height: 310px;">
              {% if bdt_accounts_with_bal %}
                {% for a in bdt_accounts_with_bal %}
                  <div class="card account-tile mb-4">
                    <div class="card-body d-flex align-items-center gap-2">
                      <!-- Initial badge (swap to logo img if you have one) -->
                      <div class="bank-badge">{{ (a.name or 'â€”')[:3] }}</div>

                      <div class="flex-grow-1 min-w-0 h-100">
                        <div class="bank-name text-truncate" title="{{ a.name }}">{{ a.name }}</div>
                        <div class="tiny text-muted">BDT Account</div>
                      </div>

                      <div class="ms-auto text-end">
                        <div class="balance">à§³{{ "{:,}".format((a.balance or 0)|int) }}</div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="p-3 text-muted tiny">No active BDT accounts.</div>
              {% endif %}
            </div>
          </div>
       </div>
      </div>
    </div><!-- /Third Column -->
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
{% endblock %}
{# End of templates/index.html #}