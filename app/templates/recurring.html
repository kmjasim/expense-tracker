{% extends "pay_shell.html" %}
{% set page_slug = "recurring" %}
{% block content %}


<div class="accordion mb-4" id="recurringAccordion">
  <form action="{{ url_for('main.recurring_create') }}" method="post">

    <!-- Transaction Details -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingDetails">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseDetails" aria-expanded="true">
          <i class="bi bi-cash me-2"></i> Transaction Details
        </button>
      </h2>
      <div id="collapseDetails" class="accordion-collapse collapse show"
           data-bs-parent="#recurringAccordion">
        <div class="accordion-body row g-3">
          <div class="col-md-4">
            <label class="form-label">Account</label>
            <select name="account_id" class="form-select" required>
              {% for a in accounts %}
              <option value="{{ a.id }}">{{ a.name }} ({{ a.currency.value }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Type</label>
            <select name="type" class="form-select">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
              <option value="fee">Fee</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Amount</label>
            <input type="number" step="0.01" min="0.01" name="amount" class="form-control" required>
          </div>
          <div class="col-md-5">
            <label class="form-label">Category</label>
            <select name="category_id" class="form-select">
              <option value="">Uncategorized</option>
              {% for c in categories %}
              <option value="{{ c.id }}">{{ c.path }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-7">
            <label class="form-label">Note</label>
            <input type="text" name="note" class="form-control" placeholder="(optional)">
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingSchedule">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseSchedule" aria-expanded="false">
          <i class="bi bi-calendar-event me-2"></i> Schedule
        </button>
      </h2>
      <div id="collapseSchedule" class="accordion-collapse collapse"
           data-bs-parent="#recurringAccordion">
        <div class="accordion-body row g-3">
          <div class="col-md-3">
            <label class="form-label">Frequency</label>
            <select name="frequency" class="form-select">
              <option value="monthly">Monthly</option>
              <option value="weekly">Weekly</option>
              <option value="daily">Daily</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Every</label>
            <input type="number" name="every_n" class="form-control" value="1" min="1">
          </div>
          <div class="col-md-3">
            <label class="form-label">Start date</label>
            <input type="date" name="start_date" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">End date</label>
            <input type="date" name="end_date" class="form-control">
          </div>
        </div>
      </div>
    </div>

    <!-- Advanced Scheduling -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingAdvanced">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseAdvanced" aria-expanded="false">
          <i class="bi bi-sliders me-2"></i> Advanced Scheduling
        </button>
      </h2>
      <div id="collapseAdvanced" class="accordion-collapse collapse"
           data-bs-parent="#recurringAccordion">
        <div class="accordion-body row g-3">
          <div class="col-md-3">
            <label class="form-label">Weekday (0â€“6)</label>
            <input type="number" name="weekday" class="form-control" min="0" max="6" placeholder="weekly">
          </div>
          <div class="col-md-3">
            <label class="form-label">Day of month</label>
            <input type="number" name="day_of_month" class="form-control" min="1" max="31" placeholder="monthly">
          </div>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="mt-3">
      <button class="btn btn-primary">
        <i class="bi bi-check2-circle me-1"></i> Create
      </button>
    </div>
  </form>
</div>

<!-- Run Now -->
<form action="{{ url_for('main.recurring_run_now') }}" method="post" class="mb-3">
  <button class="btn btn-outline-secondary">
    <i class="bi bi-play-circle me-1"></i> Run Due Now
  </button>
</form>


<div class="table-responsive">
<table class="table table-sm align-middle table-bordered table-striped">
  <thead class="table-dark">
    <tr>
      <th>#</th><th>Account</th><th>Type</th><th>Amount</th>
      <th>Freq</th><th>Every</th><th>Next run</th><th>Enabled</th><th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rules %}
    <tr>
      <td>{{ r.id }}</td>
      <td>{{ r.account.name }}</td>
      <td>{{ r.type.value }}</td>
      <td>{{ "{:,.2f}".format(r.amount) }}</td>
      <td>{{ r.frequency.value }}</td>
      <td>{{ r.every_n }}</td>
      <td>{{ r.next_run.isoformat() }}</td>
      <td>{{ "Yes" if r.is_enabled else "No" }}</td>
      <td class="d-flex gap-2">
        <form action="{{ url_for('main.recurring_toggle', rid=r.id) }}" method="post">
          <button class="btn btn-sm {{ 'btn-warning' if r.is_enabled else 'btn-success' }}">
            {{ 'Disable' if r.is_enabled else 'Enable' }}
          </button>
        </form>
        <form action="{{ url_for('main.recurring_delete', rid=r.id) }}" method="post"
              onsubmit="return confirm('Delete rule {{ r.id }}?');">
          <button class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="9" class="text-muted">No recurring rules yet.</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% endblock %}
