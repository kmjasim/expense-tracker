{# templates/payments.html #}
{% extends "pay_shell.html" %}

{# ----------------------------
   LEFT PANEL: Categories + Add
   ---------------------------- #}
{% block left_panel %}
<div class="left-pane">

  {% if warning_message %}
    <div class="alert alert-warning py-2 px-3 small mb-2" role="alert">
      {{ warning_message }}
    </div>
  {% endif %}

  <!-- Scrollable category tree -->
  <div class="left-scroll">
    {% import "macros/category_tree.html" as tree %}
    {{ tree.render(top_categories, active_category_id) }}
  </div>

  <!-- Add button (fixed at bottom) -->
  <div class="d-grid mt-2">
    <button class="btn btn-success btn-sm rounded-3"
            type="button" data-bs-toggle="modal" data-bs-target="#categoryModal">
      Add Category
    </button>
  </div>

</div>

{# Category create modal #}
{% include "partials/_category_modal.html" %}
{% endblock %}


{# ----------------------------
   MAIN PANEL: Payment form
   ---------------------------- #}
{% block panel_content %}
<div class="transfer-card">
  <form method="post" action="{{ url_for('main.payments_create') }}" id="paymentForm" novalidate>
  <input type="hidden" name="category_id" id="category_id" value="{{ active_category_id or '' }}">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0">Payment Account</h6>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-info btn-sm" id="setBalanceBtn" type="button"
        data-bs-toggle="modal" data-bs-target="#setBalanceModal" disabled>
        <i class="bi bi-wallet"></i> Set Balance
      </button>

      <button class="btn btn-outline-primary btn-sm" type="button"
              data-bs-toggle="modal" data-bs-target="#accountNewModal">
        <i class="bi bi-plus-lg"></i> New
      </button>
      <button class="btn btn-outline-secondary btn-sm" id="editAccountBtn" type="button"
              data-bs-toggle="modal" data-bs-target="#accountEditModal">
        <i class="bi bi-pencil"></i> Edit
      </button>
      <button class="btn btn-outline-warning btn-sm" id="setLimitBtn" type="button"
        data-bs-toggle="modal" data-bs-target="#setLimitModal" disabled>
        <i class="bi bi-credit-card-2-back"></i> Set Limit
      </button>
      <button class="btn btn-outline-danger btn-sm" id="settleBtn" type="button"
        data-bs-toggle="modal" data-bs-target="#settleModal" disabled>
        <i class="bi bi-wallet2"></i> Settle Card
      </button>

    </div>
  </div>

  <!-- Accounts slider -->
  <div class="account-slider d-flex align-items-center gap-2 mb-3">
    <div class="slider-viewport py-3">
      <div class="slider-track">
        {% if accounts and accounts|length %}
          {% for a in accounts %}
            {% set curr_code = (a.currency.value if a.currency is not string else a.currency)|string|upper %}
            {% set type_code = (a.type.value if a.type is not string else a.type)|string|lower %}
            {% set sym_map   = {"KRW": "₩", "BDT": "৳"} %}
            <label class="acct-card {% if loop.first %}active{% endif %} {% if not a.is_active %}is-inactive{% endif %}"
                  data-id="{{ a.id }}"
                  data-name="{{ a.name|e }}"
                  data-currency="{{ curr_code }}"
                  data-type="{{ type_code }}"
                  data-initial="{{ a.initial_balance or 0 }}"
                  data-active="{{ 1 if a.is_active else 0 }}"
                  data-symbol="{{ sym_map.get(curr_code, '') }}"
                  data-balance="{{ (balances.get(a.id) or 0) }}"
                  data-limit="{{ (a.credit_limit or 0) | float }}"
                  data-pending="{{ (pending_totals.get(a.id) or 0) | float }}">
              <input class="d-none acct-radio" type="radio" name="account_id"
                    value="{{ a.id }}" {% if not a.is_active %}disabled{% endif %}
                    {% if loop.first %}checked{% endif %}>

              <div class="acct-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="badge rounded-pill text-bg-light">{{ type_code|capitalize }}</span>
                  <span class="small text-muted">{{ curr_code }}</span>
                </div>

                <div class="fw-bold d-flex align-items-center gap-2">
                  <i class="bi bi-grip-vertical text-muted sort-handle" title="Drag"></i>
                  {{ a.name }}
                  {% if not a.is_active %}
                    <span class="badge text-bg-secondary ms-2">Inactive</span>
                  {% endif %}
                </div>

                <div class="display-9 fw-semibold my-1">
                  {% if a.type == AccountType.credit %}
                    <div class="d-flex align-items-baseline justify-content-between">
                      <div class="fw-bold">
                        Available:
                        <span data-role="avail">
                          {{ currency_symbol(a) }}{{ (balances.get(a.id) or 0) | money }}
                        </span>
                      </div>
                      <div class="small text-muted">
                        Pending:
                        {{ currency_symbol(a) }}{{ (pending_totals.get(a.id) or 0) | money }}
                      </div>
                    </div>

                    {# Progress bar #}
                    {% set avail = balances.get(a.id) or 0 %}
                    {% set orig_limit = a.credit_limit or 0 %}
                    {% set used = (orig_limit - avail) if orig_limit > 0 else 0 %}
                    {% set pct = (used / orig_limit * 100) if orig_limit > 0 else 0 %}

                    <div class="limit-bar mt-2" role="progressbar" aria-label="Credit limit usage">
                      <div class="limit-bar-fill
                                  {% if pct >= 80 %} bg-danger
                                  {% elif pct >= 50 %} bg-warning
                                  {% else %} bg-success
                                  {% endif %}"
                          style="width: {{ "%.0f"|format(pct) }}%;">
                      </div>
                    </div>

                    <div class="d-flex justify-content-between small mt-1">
                      <span class="text-muted">Remaining</span>
                      <span data-role="used" class="fw-semibold">
                        {{ "%.0f"|format(pct) }}% used
                      </span>
                    </div>
                  {% else %}
                    {{ currency_symbol(a) }}{{ (balances.get(a.id) or 0) | money }}
                  {% endif %}
                </div>


              </div>
            </label>


          {% endfor %}
        {% else %}
          <div class="p-3 text-muted small">No active accounts yet. Create one to make a payment.</div>
        {% endif %}
      </div>
          <!-- overlay controls in the top-right corner -->
      <div class="slider-controls top-right" aria-hidden="false">
        <button class="btn slider-nav prev" type="button" aria-label="Previous">‹</button>
        <button class="btn slider-nav next" type="button" aria-label="Next">›</button>
      </div>
    </div>
  </div>
  <!-- Category + Subcategory -->
  <div class="row g-2 mb-3">
    <div class="col-12 col-md-6">
      <label class="form-label">Category</label>
      <select id="selectCategory" class="form-select">
        <option value="">— Select a category —</option>
      </select>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Subcategory</label>
      <select id="selectSubcategory" class="form-select">
        <option value="">— Optional subcategory —</option>
      </select>
    </div>
  </div>

  <!-- Type + Date -->
  <div class="row g-2 mb-3">
    <div class="col-12 col-md-6">
      <label class="form-label">Type</label>
      {# Keep types aligned with backend: income | expense | fee #}
      <select name="type" class="form-select" required>
        <option value="expense" selected>Expense</option>
        <option value="fee">Fee</option>
        <option value="income">Income</option>
      </select>
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">Date</label>
      <input type="date" name="date" class="form-control" value="{{ today }}" required>
    </div>
  </div>

  <!-- Amount + Note -->
  <div class="row g-2 mb-3">
    <div class="col-12 col-md-6">
      <label class="form-label">Amount</label>
      <div class="input-group">
        <span class="input-group-text" id="amtSymbol">
          {% set first = accounts[0] if accounts and accounts|length else None %}
          {{ currency_symbol(first) }}
        </span>
        <input type="number" step="0.01" inputmode="decimal" name="amount"
               class="form-control" placeholder="0.00" required>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Note</label>
      <input type="text" name="note" class="form-control" placeholder="Optional note">
    </div>
  </div>

  <!-- Actions -->
  <div class="d-flex justify-content-end gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('main.payments_page') }}">Cancel</a>
    <button class="btn btn-success" type="submit">Make Payment</button>
  </div>
</form>
{% endblock %}


{# ----------------------------
   GLOBAL MODALS: Account create/edit
   ---------------------------- #}
{% block global_modals %}
  <!-- New Account -->
  <div class="modal fade" id="accountNewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" method="post" action="{{ url_for('main.account_create') }}">
        <div class="modal-header">
          <h5 class="modal-title">Add Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body g-2">
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input name="name" class="form-control" required placeholder="e.g., KB Savings">
          </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Currency</label>
                <select name="currency" class="form-select" required>
                  <option value="KRW">KRW</option>
                  <option value="BDT">BDT</option>
                </select>
              </div>

              <div class="col-6">
                <label class="form-label">Type</label>
                <select name="type" id="acctTypeCreate" class="form-select" required>
                  <option value="bank">Bank</option>
                  <option value="credit">Credit</option>
                  <option value="cash">Cash</option>
                  <option value="mobile_wallet">Mobile wallet</option>
                </select>
              </div>
            </div>

            <div class="row g-2">
              <div class="col-12">
                <label class="form-label" data-role="amt-label">Initial balance</label>
                <div class="input-group">
                  <span class="input-group-text" data-role="amt-sym">₩</span>
                  <input
                    data-role="amt-input"
                    name="initial_balance"
                    type="number"
                    step="0.01"
                    inputmode="decimal"
                    class="form-control"
                    placeholder="0.00"
                    value="0.00"
                    required>
                </div>
                <div class="form-text" data-role="amt-help">
                  For credit cards, this will become the available credit limit.
                </div>
              </div>
            </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_active" id="accNewActive" checked>
            <label class="form-check-label" for="accNewActive">Active</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Account -->
  <div class="modal fade" id="accountEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" method="post" action="{{ url_for('main.account_update') }}">
        <input type="hidden" name="id" id="accEditId">
        <div class="modal-header">
          <h5 class="modal-title">Edit Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body g-2">
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input name="name" id="accEditName" class="form-control" required>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Currency</label>
              <select name="currency" id="accEditCurrency" class="form-select" required>
                <option value="KRW">KRW</option>
                <option value="BDT">BDT</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Type</label>
              <select name="type" id="accEditType" class="form-select" required>
                <option value="bank">Bank</option>
                <option value="credit">Credit</option>
                <option value="cash">Cash</option>
                <option value="mobile_wallet">Mobile wallet</option>
              </select>
            </div>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_active" id="accEditActive">
            <label class="form-check-label" for="accEditActive">Active</label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-danger me-auto" formaction="{{ url_for('main.account_delete') }}" formmethod="post"
                  onclick="return confirm('Delete this account?');">
            <i class="bi bi-trash"></i> Delete
          </button>
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Save changes</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Set Credit Limit Modal -->
<div class="modal fade" id="setLimitModal" tabindex="-1" aria-labelledby="setLimitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" method="post" action="{{ url_for('main.accounts_set_limit') }}">
      <div class="modal-header">
        <h5 class="modal-title" id="setLimitModalLabel">Set Credit Card Limit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="account_id" id="limitAccountId">
        <div class="mb-3">
          <label class="form-label">Account</label>
          <input type="text" class="form-control" id="limitAccountName" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Available Limit</label>
          <div class="input-group">
            <span class="input-group-text" id="limitCurrencySym">₩</span>
            <input type="number" step="0.01" inputmode="decimal" name="credit_limit" id="limitValue" class="form-control" placeholder="0.00" required>
          </div>
          <div class="form-text">This sets the **available** limit now. (We can add max vs available later.)</div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save Limit</button>
      </div>
    </form>
  </div>
</div>
<!-- Settle Credit Card Modal -->
<div class="modal fade" id="settleModal" tabindex="-1" aria-labelledby="settleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" method="post" action="{{ url_for('main.payments_settle') }}">
      <div class="modal-header">
        <h5 class="modal-title" id="settleModalLabel">Settle Credit Card</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="card_id" id="settleCardId">

        <div class="mb-2">
          <label class="form-label">Card</label>
          <input type="text" id="settleCardName" class="form-control" readonly>
        </div>

        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label">Pending</label>
            <div class="form-control" id="settlePending" readonly>0.00</div>
          </div>
          <div class="col-6">
            <label class="form-label">Available</label>
            <div class="form-control" id="settleAvailable" readonly>0.00</div>
          </div>
        </div>

        <div class="mb-2">
          <label class="form-label d-flex justify-content-between">
            <span>Pay From Account</span>
            <span class="small text-muted" id="settleCurrencyHint"></span>
          </label>
          <select class="form-select" name="from_account_id" id="settleFromAccount" required>
            <option value="">— Select account —</option>
            {% for a in accounts if a.type != AccountType.credit %}
              <option value="{{ a.id }}" data-currency="{{ a.currency.value }}">{{ a.name }} ({{ a.currency.value }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="settleFullSwitch" checked>
          <label class="form-check-label" for="settleFullSwitch">Pay full pending amount</label>
        </div>

        <div class="mb-1">
          <label class="form-label">Amount</label>
          <div class="input-group">
            <span class="input-group-text" id="settleSym">₩</span>
            <input type="number" step="0.01" inputmode="decimal" class="form-control"
                   name="amount" id="settleAmount" required>
          </div>
          <div class="form-text">Settlement adds back to available limit and marks all pending as paid (full).</div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" type="submit">Settle</button>
      </div>
    </form>
  </div>
</div>
<!-- Set Balance (Exact) Modal -->
<div class="modal fade" id="setBalanceModal" tabindex="-1" aria-labelledby="setBalanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" method="post" action="{{ url_for('main.accounts_set_balance_exact') }}">
      <div class="modal-header">
        <h5 class="modal-title" id="setBalanceModalLabel">Set Balance (Exact)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="account_id" id="sbAccountId">

        <div class="mb-2">
          <label class="form-label">Account</label>
          <input type="text" class="form-control" id="sbAccountName" readonly>
        </div>

        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label">Current Shown</label>
            <div class="form-control" id="sbCurrent" readonly>0.00</div>
          </div>
          <div class="col-6">
            <label class="form-label">Currency</label>
            <div class="form-control" id="sbCurrency" readonly></div>
          </div>
        </div>

        <div class="mb-1">
          <label class="form-label">New Shown Balance</label>
          <div class="input-group">
            <span class="input-group-text" id="sbSym">₩</span>
            <input type="number" step="0.01" inputmode="decimal"
                   class="form-control" name="target_balance" id="sbTarget" required>
          </div>
          <div class="form-text">
            This will set the displayed balance to this exact amount (does not modify past transactions).
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-info" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>
</div>

{% endblock %}


{# ----------------------------
   PAGE SCRIPTS
   ---------------------------- #}
{% block scripts %}
  <script>
    window.CAT_DATA = {{ (cat_json or []) | tojson }};
    window.SELECTED_PARENT_ID = {{ selected_parent_id | tojson }};
    window.SELECTED_CHILD_ID  = {{ selected_child_id  | tojson }};
    window.REORDER_URL = "{{ url_for('main.accounts_reorder') }}";
  </script>

  <script src="{{ url_for('static', filename='js/payments.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/accounts_reorder.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/slider_nav.js') }}" defer></script>
{% endblock %}

