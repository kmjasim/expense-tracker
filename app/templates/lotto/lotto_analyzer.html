{% extends "base.html" %}
{% block content %}

<div class="container-fluid">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Lotto Analyzer</h3>
  </div>
{% from "partials/_lotto_macros.html" import ball, ball_list %}


  {% if message is not none %}
    <div class="alert {% if ok %}alert-success{% else %}alert-danger{% endif %} py-2">
      {{ message }}
    </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-header">
      <strong>Add Draw</strong>
    </div>
    <div class="card-body">
      <form method="POST" class="row g-2">
        <div class="col-md-2">
          <label class="form-label">Round No</label>
          <input type="number" name="round_no" class="form-control" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Draw Date</label>
          <input type="date" name="draw_date" class="form-control" required>
        </div>

        <div class="col-md-5">
          <label class="form-label">Numbers (6)</label>
          <input type="text" name="numbers" class="form-control" placeholder="e.g. 3, 11, 18, 27, 33, 41" required>
          <div class="form-text">Comma or space separated is fine.</div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Bonus</label>
          <input type="number" name="bonus" class="form-control" required>
        </div>

        <div class="col-12">
          <button class="btn btn-primary">
            Save Draw
          </button>
        </div>
      </form>
    </div>
  </div>
<div class="card mb-3">
  <div class="card-header d-flex align-items-center justify-content-between">
    <strong>Quick Analysis</strong>

    <form method="get" class="d-flex gap-2 align-items-center">
      <label class="small text-muted mb-0">Window</label>
      <select name="window" class="form-select form-select-sm" style="width: 120px;">
        {% for w in [10, 20, 50, 100, 200, 500, 1205] %}
          <option value="{{ w }}" {% if w == selected_window %}selected{% endif %}>
            Last {{ w }}
          </option>
        {% endfor %}
      </select>
      <button class="btn btn-sm btn-primary" type="submit">Apply</button>
    </form>
  </div>

  <div class="card-body">
    <div class="row g-3">

      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Hot Numbers</strong>
            <span class="text-muted small">Top 10</span>
          </div>

          {% for item in hot_numbers %}
            {{ ball(item.num) }}
            <span class="text-primary small me-2">({{ item.cnt }})</span>
          {% endfor %}

        </div>
      </div>

      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Cold Numbers</strong>
            <span class="text-muted small">Bottom 10</span>
          </div>

          {% for item in cold_numbers %}
            {{ ball(item.num) }}
            <span class="text-primary small me-2">({{ item.cnt }})</span>
          {% endfor %}

        </div>
      </div>

      <div class="col-12">
        <div class="border rounded p-3">
          <strong>Distribution (Window)</strong>
          <div class="row mt-2 g-3">
            <div class="col-md-6">
              <div class="small text-muted mb-1">Odd/Even</div>
              <div class="d-flex gap-2 flex-wrap">
                {% for k, v in odd_even_dist.items() %}
                  <span class="badge text-bg-light border">
                    {{ k }}: <strong>{{ v }}</strong>
                  </span>
                {% endfor %}
              </div>
            </div>

            <div class="col-md-6">
              <div class="small text-muted mb-1">Low/High</div>
              <div class="d-flex gap-2 flex-wrap">
                {% for k, v in low_high_dist.items() %}
                  <span class="badge text-bg-light border">
                    {{ k }}: <strong>{{ v }}</strong>
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12">
  <div class="border rounded p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <strong>Top Pairs (Window)</strong>
      <span class="text-muted small">Top 20</span>
    </div>

    {% if top_pairs %}
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 80px;">Rank</th>
              <th>Pair</th>
              <th style="width: 120px;">Count</th>
            </tr>
          </thead>
          <tbody>
            {% for p in top_pairs %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>
                  {{ ball(p.a) }}
                  {{ ball(p.b) }}
                </td>

                <td><strong>{{ p.cnt }}</strong></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No data</div>
    {% endif %}
  </div>
</div>


    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-header">
    <strong>Smart Generator</strong>
  </div>

  <div class="card-body">
    <form method="post" class="row g-2 align-items-end">
      <input type="hidden" name="action" value="generate">

      <div class="col-md-3">
        <label class="form-label small text-muted">Window</label>
        <select name="gen_window" class="form-select form-select-sm">
          {% for w in [20, 50, 100, 200, 500] %}
            <option value="{{ w }}">{{ w }} draws</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label small text-muted">How many sets</label>
        <select name="gen_count" class="form-select form-select-sm">
          {% for c in [1,2,3,4,5] %}
            <option value="{{ c }}">{{ c }} set{{ 's' if c>1 else '' }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <button class="btn btn-primary btn-sm" type="submit" name="action" value="generate">
          Generate
        </button>

      </div>
    </form>

    {% if generated_picks %}
      <hr>
      <div class="d-flex flex-column gap-2">
        {% for p in generated_picks %}
          <div class="border rounded p-2 d-flex justify-content-between align-items-center flex-wrap">
            <div>
              {{ ball_list(p.numbers) }}
            </div>

            <div class="text-muted small">
              Score: <strong>{{ p.score }}</strong> |
              Sum: {{ p.explain.sum }} |
              O/E: {{ p.explain.odd_even }} |
              L/H: {{ p.explain.low_high }} |
              PairSynergy: {{ p.explain.synergy }}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

  <div class="card">
    <div class="card-header">
      <strong>Recent Draws</strong>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-striped mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>Round</th>
            <th>Date</th>
            <th>Numbers</th>
            <th>Bonus</th>
            <th>Sum</th>
            <th>Odd/Even</th>
            <th>Low/High</th>
            <th>Consecutive</th>
            <th>Max Run</th>
            <th>Span</th>
            <th>Avg Gap</th>
            <th>Repeat (Prev1)</th>
          </tr>
        </thead>
        <tbody>
          {% for draw, stats in draws %}
            <tr>
              <td>{{ draw.round_no }}</td>
              <td>{{ draw.draw_date }}</td>
              <td>
              {{ ball_list(numbers_map.get(draw.id, [])) }}

              </td>
              <td>
              {% if bonus_map.get(draw.id) %}
                {{ ball(bonus_map.get(draw.id), "lotto-bonus") }}
              {% endif %}

              </td>

              <td>{{ stats.sum_total if stats else "-" }}</td>
              <td>
                {% if stats %}
                  {{ stats.odd_count }}/{{ stats.even_count }}
                {% else %}-{% endif %}
              </td>
              <td>
                {% if stats %}
                  {{ stats.low_count }}/{{ stats.high_count }}
                {% else %}-{% endif %}
              </td>
              <td>{{ stats.consecutive_pairs_count if stats else "-" }}</td>
              <td>{{ stats.max_consecutive_run if stats else "-" }}</td>
              <td>{{ stats.range_span if stats else "-" }}</td>
              <td>
                {% if stats %}
                  {{ "%.2f"|format(stats.avg_gap) }}
                {% else %}-{% endif %}
              </td>
              <td>{{ stats.repeat_from_prev1 if stats and stats.repeat_from_prev1 is not none else "-" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

{% endblock %}
